name: schema-refresh

on:
  schedule:
    - cron: "17 3 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: schema-refresh
  cancel-in-progress: true

jobs:
  refresh:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Rust
        run: |
          rustup toolchain install 1.89.0 --profile minimal --component rustfmt --component clippy
          rustup default 1.89.0

      - name: Validate required secrets
        env:
          KIBELA_ORIGIN: ${{ secrets.KIBELA_ORIGIN }}
          KIBELA_ACCESS_TOKEN: ${{ secrets.KIBELA_ACCESS_TOKEN }}
        run: |
          test -n "${KIBELA_ORIGIN}" || (echo "missing secret: KIBELA_ORIGIN" && exit 1)
          test -n "${KIBELA_ACCESS_TOKEN}" || (echo "missing secret: KIBELA_ACCESS_TOKEN" && exit 1)

      - name: Preserve base resource contract snapshot
        run: |
          cp schema/contracts/resource_contracts.snapshot.json /tmp/resource_contracts.snapshot.base.json

      - name: Refresh snapshots from live endpoint
        env:
          KIBELA_ORIGIN: ${{ secrets.KIBELA_ORIGIN }}
          KIBELA_ACCESS_TOKEN: ${{ secrets.KIBELA_ACCESS_TOKEN }}
        run: |
          cargo run -p kibel-tools -- resource-contract refresh-endpoint --origin "${KIBELA_ORIGIN}" --document-fallback-mode strict
          cargo run -p kibel-tools -- create-note-contract refresh-from-endpoint

      - name: Regenerate contracts
        run: |
          cargo run -p kibel-tools -- create-note-contract write
          cargo run -p kibel-tools -- resource-contract write --document-fallback-mode strict

      - name: Diff resource contract compatibility (blocking)
        run: |
          cargo run -p kibel-tools -- resource-contract diff \
            --base /tmp/resource_contracts.snapshot.base.json \
            --target schema/contracts/resource_contracts.snapshot.json \
            --fail-on-breaking

      - name: Verify refreshed contracts
        run: |
          cargo run -p kibel-tools -- create-note-contract check
          cargo run -p kibel-tools -- resource-contract check --document-fallback-mode strict
          cargo fmt --all --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          cargo test --workspace --all-features
          cargo test -p kibel-client --doc
          RUSTDOCFLAGS="-D warnings" cargo doc --workspace --no-deps

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: refresh GraphQL schema contracts"
          title: "chore: refresh GraphQL schema contracts"
          body: |
            Automated schema refresh from live Kibela endpoint.

            - refresh create-note schema snapshot
            - refresh endpoint introspection snapshot
            - regenerate contract modules
            - run deterministic contract checks
          branch: codex/schema-refresh-auto
          delete-branch: true
          labels: |
            automation
            schema
