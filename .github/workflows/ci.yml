name: ci

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Rust
        run: |
          rustup toolchain install 1.89.0 --profile minimal --component rustfmt --component clippy
          rustup default 1.89.0

      - name: Rust format check
        run: cargo fmt --all --check

      - name: Rust clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Rust tests
        run: cargo test --workspace --all-features

      - name: Rust doctests
        run: cargo test -p kibel-client --doc

      - name: Rustdoc warnings
        run: RUSTDOCFLAGS="-D warnings" cargo doc --workspace --no-deps

      - name: Verify schema contract snapshot/codegen
        run: cargo run -p kibel-tools -- create-note-contract check

      - name: Verify all-resource contract snapshot/codegen
        run: cargo run -p kibel-tools -- resource-contract check --document-fallback-mode strict

      - name: Build kibel binary
        run: cargo build -p kibel
